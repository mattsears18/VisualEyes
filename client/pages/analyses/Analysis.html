<template name="Analysis">
  {{#if $.Session.get 'updateAnalysis'}}
    {{> UpdateAnalysis analysis=analysis}}
  {{else}}
    <h3 class="m-t-0">{{analysis.name}}
      {{#if analysis.hasPermission 'update'}}
        {{#unless $.Session.get 'updateAnalysis'}}
          &nbsp;<a href="#" class="update-analysis"><i class="fa fa-pencil"></i></a>
        {{/unless}}
      {{/if}}
      {{#unless makeViewingsJobsComplete}}
        <span class="label label-default">Creating Viewings
          {{makeViewingsJobsProgress}}%
          <i class="fa fa-spinner fa-pulse fa-fw"></i>
        </span>
      {{/unless}}
    </h3>

    <p>{{analysis.desc}}</p>

    <!-- {{#if participants.count}}
      <div><strong>Participants: </strong>
        {{#each participant in participants}}
          <a href="/studies/{{study._id}}/analyses/{{analysis._id}}/participants/{{participant._id}}">{{participant.name}}</a>
        {{/each}}
      </div>
    {{/if}} -->

    {{#if analysis.period}}
    <div><strong>Period (ms):</strong> {{formatNumber analysis.period}}</div>
    {{/if}}

    {{#if analysis.viewingGap}}
    <div><strong>Viewing Gap (ms):</strong> {{formatNumber analysis.viewingGap}}</div>
    {{/if}}

    {{#if analysis.minViewingTime}}
      <div><strong>Minimum Viewing Time (ms):</strong> {{formatNumber analysis.minViewingTime}}</div>
    {{/if}}

    <div class="selector-set">
      <h4>
        Participants {{#if participants.count}}({{participants.count}}){{/if}}
        <button class="label label-primary toggle-all selector participant">Show All</button>
      </h4>
      <h4>
        <div class="well well-sm">
          {{#each participant in participants}}
            <button class="label selector participant label-primary" data-id="{{participant._id}}">{{participant.name}}</button>
          {{/each}}
        </div>
      </h4>
    </div>

    <div class="selector-set">
      <h4>
        Areas of Interest {{#if aois.count}}({{aois.count}}){{/if}}
        <button class="label label-primary toggle-all selector aoi">Show All</button>
      </h4>
      <h4>
        <div class="well well-sm">
          {{#each aoi in aois}}
            <button class="label selector aoi label-primary" data-id="{{aoi._id}}">{{aoi.name}}</button>
          {{/each}}
        </div>
      </h4>
    </div>
    <!-- {{json showAoiIds}} -->

    {{#if viewings.count}}
      <div class="row">
        <div class="col-md-6">
          {{> PlotRegression}}
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          {{> PlotHistogramViewingDurations viewings=viewings}}
        </div>
        <div class="col-md-6">
          {{> PlotHistogramViewingCounts viewings=viewings}}
        </div>
      </div>
      <div class="row">
        <div class="col-md-6">
          {{> PlotHistogramViewingAverageSlideHullSizes viewings=viewings}}
        </div>
      </div>
    {{/if}}

    {{#if viewings.count}}
      <h4>
        Viewings ({{viewings.count}})

        {{#unless makeViewingsJobsComplete}}
          <span class="label label-default">Creating Viewings
            {{makeViewingsJobsProgress}}%
            <i class="fa fa-spinner fa-pulse fa-fw"></i>
          </span>
        {{/unless}}
      </h4>

      {{> tabular table=TabularTables.ViewingsByAnalysisId selector=selector class="table table-striped table-bordered"}}
    {{/if}}
  {{/if}}
</template>
